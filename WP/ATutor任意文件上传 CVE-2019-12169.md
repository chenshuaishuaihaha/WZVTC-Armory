## ATutor任意文件上传漏洞 CVE-2019-12169

ATutor2.2.4语言导入功能处存在一处安全漏洞(CVE-2019-12169)。攻击者可利用该漏洞进行远程代码执行攻击。

### 漏洞分析

据漏洞披露可知，漏洞触发点存在于mods/_core/languages/language_import.php文件中

首先跟入language_import.php文件，在35行起，可以发现关于文件上传相关代码

![img](images/ATutor%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20CVE-2019-12169.assets/20200424170655-f1f7f882-860a-1.png)

此处代码块对文件上传情况进行校验后进入下一个if，程序将调用\$languageManager->import方法对文件进行处理

继续跟入import方法

![img](images/ATutor%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20CVE-2019-12169.assets/20200424170733-085bc2d4-860b-1.png)

在import方法中，首先确认了用来保存上传文件的路径\$import_path，接着调用PclZip对压缩包进行处理。

![img](images/ATutor%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20CVE-2019-12169.assets/20200424170750-12c4778e-860b-1.png)

首先我们构造一个poc.php

```
<?php phpinfo(); ?>
```

再将这个poc.php打包为poc.zip，访问如下链接以进入上传页面

```
http://target/ATutor/mods/_core/languages/language_import.php
```

![img](images/ATutor%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20CVE-2019-12169.assets/20200424170852-37944eea-860b-1.png)

在上传语言包页面中选择构造好的poc.zip并点击import按钮上传

传入指定目录下后，程序调用PclZip的extract方法对压缩包进行解压，在解压过程中使用了extract方法。该方法中第一个参数是设置项，第二个是对应设置项的值

我们来看下PCLZIP_OPT_PATH设置项的作用

![img](images/ATutor%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20CVE-2019-12169.assets/20200424171002-61af3a0a-860b-1.png)

可见，PCLZIP_OPT_PATH设置项指定我们上传的zip文件解压目录为\$import_path参数对应的路径

解压成功后，poc.zip中内容出现在对应文件夹中

![img](images/ATutor%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20CVE-2019-12169.assets/20200424171017-6a7f415c-860b-1.png)

查看poc.php中的值，可以发现poc上传成功

![img](images/ATutor%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20CVE-2019-12169.assets/20200424171031-72c2b25e-860b-1.png)

访问如下地址，触发poc

![img](images/ATutor%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%20CVE-2019-12169.assets/20200424171047-7c27e9b8-860b-1.png)

除此之外，该应用几乎所有import接口，在后台都采用PclZip将上传的zip解压到对应目录中。然而这些操作无一例外的未对压缩包中的文件进行校验

例如

- 位于mods/_core/themes/import.php文件中的主题导入功能
- 位于/mods/_standard/tests/question_import.php文件的问题导入功能
- 位于mods/_standard/patcher/index_admin.php文件的补丁导入功能